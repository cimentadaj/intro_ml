<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Regularization | Machine Learning for Social Scientists</title>
  <meta name="description" content="Notes, content and exercises for the RECSM 2020 course Machine Learning for Social Scientists." />
  <meta name="generator" content="bookdown 0.19 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Regularization | Machine Learning for Social Scientists" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="http://cimentadaj.github.io/ml_socsci/" />
  
  <meta property="og:description" content="Notes, content and exercises for the RECSM 2020 course Machine Learning for Social Scientists." />
  <meta name="github-repo" content="cimentadaj/ml_socsci" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Regularization | Machine Learning for Social Scientists" />
  
  <meta name="twitter:description" content="Notes, content and exercises for the RECSM 2020 course Machine Learning for Social Scientists." />
  

<meta name="author" content="Jorge Cimentada" />


<meta name="date" content="2020-07-08" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="machine-learning-for-social-scientists.html"/>
<link rel="next" href="tree-based-methods.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="libs/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.13/datatables.js"></script>
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
<link href="libs/crosstalk-1.1.0.1/css/crosstalk.css" rel="stylesheet" />
<script src="libs/crosstalk-1.1.0.1/js/crosstalk.min.js"></script>
<script src="libs/plotly-binding-4.9.2.1/plotly.js"></script>
<script src="libs/typedarray-0.1/typedarray.min.js"></script>
<link href="libs/plotly-htmlwidgets-css-1.52.2/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="libs/plotly-main-1.52.2/plotly-latest.min.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Machine Learning for Social Scientists</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="machine-learning-for-social-scientists.html"><a href="machine-learning-for-social-scientists.html"><i class="fa fa-check"></i><b>1</b> Machine Learning for Social Scientists</a><ul>
<li class="chapter" data-level="1.1" data-path="machine-learning-for-social-scientists.html"><a href="machine-learning-for-social-scientists.html#a-different-way-of-thinking"><i class="fa fa-check"></i><b>1.1</b> A different way of thinking</a></li>
<li class="chapter" data-level="1.2" data-path="machine-learning-for-social-scientists.html"><a href="machine-learning-for-social-scientists.html#split-your-data-into-trainingtesting"><i class="fa fa-check"></i><b>1.2</b> Split your data into training/testing</a></li>
<li class="chapter" data-level="1.3" data-path="machine-learning-for-social-scientists.html"><a href="machine-learning-for-social-scientists.html#cross-validation"><i class="fa fa-check"></i><b>1.3</b> Cross-validation</a></li>
<li class="chapter" data-level="1.4" data-path="machine-learning-for-social-scientists.html"><a href="machine-learning-for-social-scientists.html#bias-variance-tradeoff"><i class="fa fa-check"></i><b>1.4</b> Bias-Variance Tradeoff</a></li>
<li class="chapter" data-level="1.5" data-path="machine-learning-for-social-scientists.html"><a href="machine-learning-for-social-scientists.html#an-example"><i class="fa fa-check"></i><b>1.5</b> An example</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="regularization.html"><a href="regularization.html"><i class="fa fa-check"></i><b>2</b> Regularization</a><ul>
<li class="chapter" data-level="2.1" data-path="regularization.html"><a href="regularization.html#ridge-regularization"><i class="fa fa-check"></i><b>2.1</b> Ridge regularization</a></li>
<li class="chapter" data-level="2.2" data-path="regularization.html"><a href="regularization.html#lasso-regularization"><i class="fa fa-check"></i><b>2.2</b> Lasso regularization</a></li>
<li class="chapter" data-level="2.3" data-path="regularization.html"><a href="regularization.html#elastic-net-regularization"><i class="fa fa-check"></i><b>2.3</b> Elastic Net regularization</a></li>
<li class="chapter" data-level="2.4" data-path="regularization.html"><a href="regularization.html#exercises"><i class="fa fa-check"></i><b>2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="tree-based-methods.html"><a href="tree-based-methods.html"><i class="fa fa-check"></i><b>3</b> Tree-based methods</a><ul>
<li class="chapter" data-level="3.1" data-path="tree-based-methods.html"><a href="tree-based-methods.html#decision-trees"><i class="fa fa-check"></i><b>3.1</b> Decision trees</a><ul>
<li class="chapter" data-level="3.1.1" data-path="tree-based-methods.html"><a href="tree-based-methods.html#advancedsplit"><i class="fa fa-check"></i><b>3.1.1</b> Advanced: how do trees choose where to split?</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="tree-based-methods.html"><a href="tree-based-methods.html#bagging"><i class="fa fa-check"></i><b>3.2</b> Bagging</a></li>
<li class="chapter" data-level="3.3" data-path="tree-based-methods.html"><a href="tree-based-methods.html#random-forests"><i class="fa fa-check"></i><b>3.3</b> Random Forests</a></li>
<li class="chapter" data-level="3.4" data-path="tree-based-methods.html"><a href="tree-based-methods.html#boosting"><i class="fa fa-check"></i><b>3.4</b> Boosting</a></li>
<li class="chapter" data-level="3.5" data-path="tree-based-methods.html"><a href="tree-based-methods.html#exercises-1"><i class="fa fa-check"></i><b>3.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="loss-functions.html"><a href="loss-functions.html"><i class="fa fa-check"></i><b>4</b> Loss functions</a><ul>
<li class="chapter" data-level="4.1" data-path="loss-functions.html"><a href="loss-functions.html#continuous-loss-functions"><i class="fa fa-check"></i><b>4.1</b> Continuous loss functions</a><ul>
<li class="chapter" data-level="4.1.1" data-path="loss-functions.html"><a href="loss-functions.html#root-mean-square-error-rmse"><i class="fa fa-check"></i><b>4.1.1</b> Root Mean Square Error (RMSE)</a></li>
<li class="chapter" data-level="4.1.2" data-path="loss-functions.html"><a href="loss-functions.html#mean-absolute-error"><i class="fa fa-check"></i><b>4.1.2</b> Mean Absolute Error</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="loss-functions.html"><a href="loss-functions.html#binary-loss-functions"><i class="fa fa-check"></i><b>4.2</b> Binary loss functions</a><ul>
<li class="chapter" data-level="4.2.1" data-path="loss-functions.html"><a href="loss-functions.html#confusion-matrices"><i class="fa fa-check"></i><b>4.2.1</b> Confusion Matrices</a></li>
<li class="chapter" data-level="4.2.2" data-path="loss-functions.html"><a href="loss-functions.html#roc-curves-and-area-under-the-curve"><i class="fa fa-check"></i><b>4.2.2</b> ROC Curves and Area Under the Curve</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="unsupervised-methods.html"><a href="unsupervised-methods.html"><i class="fa fa-check"></i><b>5</b> Unsupervised methods</a><ul>
<li class="chapter" data-level="5.1" data-path="unsupervised-methods.html"><a href="unsupervised-methods.html#principal-component-analysis-pca"><i class="fa fa-check"></i><b>5.1</b> Principal Component Analysis (PCA)</a></li>
<li class="chapter" data-level="5.2" data-path="unsupervised-methods.html"><a href="unsupervised-methods.html#k-means-clustering"><i class="fa fa-check"></i><b>5.2</b> K-Means Clustering</a></li>
<li class="chapter" data-level="5.3" data-path="unsupervised-methods.html"><a href="unsupervised-methods.html#exercises-2"><i class="fa fa-check"></i><b>5.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="no-free-lunch.html"><a href="no-free-lunch.html"><i class="fa fa-check"></i><b>6</b> No free lunch</a><ul>
<li class="chapter" data-level="6.1" data-path="no-free-lunch.html"><a href="no-free-lunch.html#causal-inference"><i class="fa fa-check"></i><b>6.1</b> Causal Inference</a></li>
<li class="chapter" data-level="6.2" data-path="no-free-lunch.html"><a href="no-free-lunch.html#explaining-complex-models"><i class="fa fa-check"></i><b>6.2</b> Explaining complex models</a></li>
<li class="chapter" data-level="6.3" data-path="no-free-lunch.html"><a href="no-free-lunch.html#inference"><i class="fa fa-check"></i><b>6.3</b> Inference</a></li>
<li class="chapter" data-level="6.4" data-path="no-free-lunch.html"><a href="no-free-lunch.html#prediction"><i class="fa fa-check"></i><b>6.4</b> Prediction</a></li>
<li class="chapter" data-level="6.5" data-path="no-free-lunch.html"><a href="no-free-lunch.html#prediction-challenge"><i class="fa fa-check"></i><b>6.5</b> Prediction challenge</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="syllabus.html"><a href="syllabus.html"><i class="fa fa-check"></i><b>7</b> Syllabus</a><ul>
<li class="chapter" data-level="7.1" data-path="syllabus.html"><a href="syllabus.html#course-description"><i class="fa fa-check"></i><b>7.1</b> Course description</a></li>
<li class="chapter" data-level="7.2" data-path="syllabus.html"><a href="syllabus.html#schedule"><i class="fa fa-check"></i><b>7.2</b> Schedule</a></li>
<li class="chapter" data-level="7.3" data-path="syllabus.html"><a href="syllabus.html#software"><i class="fa fa-check"></i><b>7.3</b> Software</a></li>
<li class="chapter" data-level="7.4" data-path="syllabus.html"><a href="syllabus.html#prerequisites"><i class="fa fa-check"></i><b>7.4</b> Prerequisites</a></li>
<li class="chapter" data-level="7.5" data-path="syllabus.html"><a href="syllabus.html#about-the-author"><i class="fa fa-check"></i><b>7.5</b> About the author</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Machine Learning for Social Scientists</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="regularization" class="section level1">
<h1><span class="header-section-number">Chapter 2</span> Regularization</h1>
<p>Regularization is a common topic in machine learning and bayesian statistics. In this chapter, we will describe the three most common regularized linear models in the machine learning literature and introduce them in the context of the PISA data set. At the end of the document you’ll find exercises that will put your knowledge to the test. Most of the material is built upon <span class="citation">Boehmke and Greenwell (<a href="#ref-boehmke2019" role="doc-biblioref">2019</a>)</span> and <span class="citation">James et al. (<a href="#ref-james2013" role="doc-biblioref">2013</a>)</span>, which can be used as reference.</p>
<div id="ridge-regularization" class="section level2">
<h2><span class="header-section-number">2.1</span> Ridge regularization</h2>
<p>Do no let others fool you into thinking that ridge regression is a fancy artificial intelligence algorithm. Are you familiar with linear regression? If you are, then ridge regression is just an adaptation of linear regression.</p>
<p>The whole aim of linear regression, or Ordinary Least Squares (OLS), is to minimize the sum of the squared residuals. In other words, fit <code>N</code> number of regression lines to the data and keep only the one that has the lowest sum of squared residuals. In simple formula jargon, OLS tries to <strong>minimize</strong> this:</p>
<p><span class="math display">\[\begin{equation}
RSS = \sum_{k = 1}^n(actual_i - predicted_i)^2
\end{equation}\]</span></p>
<p>For each fitted regression line, you compare the predicted value (<span class="math inline">\(predicted_i\)</span>) versus the actual value (<span class="math inline">\(actual_i\)</span>), square it, and add it all up. Each fitted regression line then has an associated Residual Sum of Squares (RSS) and the linear model chooses the line with the lowest RSS.</p>
<blockquote>
<p>Note: Social scientists are familiar with the RSS and call it just by it’s name. However, be aware that in machine learning jargon, the RSS belongs to a general family called <strong>loss functions</strong>. Loss functions are metrics that evaluate the <strong>fit</strong> of your model and there are many around (such as AIC, BIC or R2).</p>
</blockquote>
<p>Ridge regression takes the previous RSS loss function and adds one term:</p>
<p><span class="math display">\[\begin{equation}
RSS + \lambda \sum_{k = 1}^n \beta^2_j
\end{equation}\]</span></p>
<p>The term on the right is called a <em>shrinkage penalty</em> because it forces each coefficient <span class="math inline">\(\beta_j\)</span> closer to zero by squaring it. The shrinkage part is clearer once you think of this term as forcing each coefficient to be as small as possible without compromising the Residual Sum of Squares (RSS). In other words, we want the smallest coefficients that don’t affect the fit of the line (RSS).</p>
<p>An intuitive example is to think of RSS and <span class="math inline">\(\sum_{k = 1}^n \beta^2_j\)</span> as two separate things. RSS estimates how the model fits the data and <span class="math inline">\(\sum_{k = 1}^n \beta^2_j\)</span> limits how much you overfit the data. Finally, the <span class="math inline">\(\lambda\)</span> between these two terms (called lambda) can be interpreted as a “weight”. The higher the lambda, the higher the weight that will be given to the shrinkage term of the equation. If <span class="math inline">\(\lambda\)</span> is 0, then multiplying 0 by <span class="math inline">\(\sum_{k = 1}^n \beta^2_j\)</span> will always return zero, forcing our previous equation to simply be reduced to the single term <span class="math inline">\(RSS\)</span>.</p>
<p>Why is there a need to “limit” how well the model fits the data? Because we, social scientists and data scientists, very commonly <strong>overfit</strong> the data. The plot below shows a simulation from <a href="https://drsimonj.svbtle.com/ridge-regression-with-glmnet">Simon Jackson</a> where we can see that when tested on a training set, OLS and Ridge tend to overfit the data. However, when tested on the test data, ridge regression has lower out of sample error as the <span class="math inline">\(R2\)</span> is higher for models with different observations.</p>
<p><img src="figs/unnamed-chunk-1-1.png" width="80%" style="display: block; margin: auto;" /></p>
<p>The strength of the ridge regression comes from the fact that it compromises fitting the training data really well for improved generalization. In other words, we increase <strong>bias</strong> (because we force the coefficients to be smaller) for lower <strong>variance</strong> (making our predictions more robust). In other words, the whole gist behind ridge regression is penalizing very large coefficients for better generalization on new data.</p>
<p>Having that intuition in mind, there is one important thing to keep in mind: the predictors of the ridge regression need to be standardized. Why is this the case? Because due to the scale of a predictor, its coefficient can be more penalized than other predictors. Suppose that you have the income of a particular person (measured in thousands per months) and time spent with their families (measured in seconds) and you’re trying to predict happiness. A one unit increase in salary could be penalized much more than a one unit increase in time spent with their families <strong>just</strong> because a one unit increase in salary can be much bigger due to it’s metric.</p>
<p>In R, you can fit a ridge regression using <code>tidymodels</code> and <code>tidyflow</code>. Let’s load the packages that we will work with and read the data:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="regularization.html#cb21-1"></a><span class="kw">library</span>(tidymodels)</span>
<span id="cb21-2"><a href="regularization.html#cb21-2"></a><span class="kw">library</span>(tidyflow)</span>
<span id="cb21-3"><a href="regularization.html#cb21-3"></a></span>
<span id="cb21-4"><a href="regularization.html#cb21-4"></a>data_link &lt;-<span class="st"> &quot;https://raw.githubusercontent.com/cimentadaj/ml_socsci/master/data/pisa_us_2018.csv&quot;</span></span>
<span id="cb21-5"><a href="regularization.html#cb21-5"></a>pisa &lt;-<span class="st"> </span><span class="kw">read.csv</span>(data_link)</span></code></pre></div>
<p>We will construct our <code>tidyflow</code> step by step. We begin with the data and then separate the training and test data. All of our modeling will be performed on the training data and the test data is saved for later (the test data must be completely ignored until you have your final tuned model). The second step is specifying the variables in the model and scaling all of them, as I have explained, we want to normalize all variables such that no variable gets more penalized than other due to their metric.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="regularization.html#cb22-1"></a><span class="co"># Specify all variables and scale</span></span>
<span id="cb22-2"><a href="regularization.html#cb22-2"></a>rcp &lt;-</span>
<span id="cb22-3"><a href="regularization.html#cb22-3"></a><span class="st">  </span><span class="co"># Define dependent (math_score) and independent variables</span></span>
<span id="cb22-4"><a href="regularization.html#cb22-4"></a><span class="st">  </span><span class="er">~</span><span class="st"> </span><span class="kw">recipe</span>(math_score <span class="op">~</span><span class="st"> </span>MISCED <span class="op">+</span><span class="st"> </span>FISCED <span class="op">+</span><span class="st"> </span>HISEI <span class="op">+</span><span class="st"> </span>REPEAT <span class="op">+</span><span class="st"> </span>IMMIG <span class="op">+</span><span class="st"> </span>DURECEC <span class="op">+</span><span class="st"> </span>BSMJ, <span class="dt">data =</span> .) <span class="op">%&gt;%</span></span>
<span id="cb22-5"><a href="regularization.html#cb22-5"></a><span class="st">  </span><span class="co"># Scale all predictors (already knows it&#39;s the independent variables)</span></span>
<span id="cb22-6"><a href="regularization.html#cb22-6"></a><span class="st">    </span><span class="kw">step_scale</span>(<span class="kw">all_predictors</span>())</span>
<span id="cb22-7"><a href="regularization.html#cb22-7"></a></span>
<span id="cb22-8"><a href="regularization.html#cb22-8"></a>tflow &lt;-</span>
<span id="cb22-9"><a href="regularization.html#cb22-9"></a><span class="st">  </span><span class="kw">tidyflow</span>(<span class="dt">seed =</span> <span class="dv">231141</span>) <span class="op">%&gt;%</span></span>
<span id="cb22-10"><a href="regularization.html#cb22-10"></a><span class="st">  </span><span class="kw">plug_data</span>(pisa) <span class="op">%&gt;%</span></span>
<span id="cb22-11"><a href="regularization.html#cb22-11"></a><span class="st">  </span><span class="kw">plug_split</span>(initial_split, <span class="dt">prop =</span> <span class="fl">.7</span>) <span class="op">%&gt;%</span></span>
<span id="cb22-12"><a href="regularization.html#cb22-12"></a><span class="st">  </span><span class="co"># Add the recipe with all variables and scale</span></span>
<span id="cb22-13"><a href="regularization.html#cb22-13"></a><span class="st">  </span><span class="kw">plug_recipe</span>(rcp)</span>
<span id="cb22-14"><a href="regularization.html#cb22-14"></a></span>
<span id="cb22-15"><a href="regularization.html#cb22-15"></a>tflow</span></code></pre></div>
<pre><code>## ══ Tidyflow ════════════════════════════════════════════════════════════════════
## Data: 4.84K rows x 501 columns
## Split: initial_split w/ prop = ~0.7
## Recipe: available
## Resample: None
## Grid: None
## Model: None</code></pre>
<p>The argument <code>prop</code> controls the proportion of the sample that will be in the training data. Here we specify it to be <code>.7</code>, 70% of the data. The third step is specifying the <strong>tuning</strong> parameters. The ridge regression has a parameter called <code>penalty</code> which needs to be set by us. <code>penalty</code> is the “weight” term in the ridge equation, which controls how much weight do we want to give to the “shrinkage penalty” (this is the <span class="math inline">\(\lambda\)</span> from the equation). If this penalty is set to 0, it means we attach <strong>no</strong> weight to the penalty term and we will get the same result over OLS. Let’s try that:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="regularization.html#cb24-1"></a><span class="co">############################# Ridge regression ################################</span></span>
<span id="cb24-2"><a href="regularization.html#cb24-2"></a><span class="co">###############################################################################</span></span>
<span id="cb24-3"><a href="regularization.html#cb24-3"></a>regularized_reg &lt;-</span>
<span id="cb24-4"><a href="regularization.html#cb24-4"></a><span class="st">  </span><span class="kw">set_engine</span>(</span>
<span id="cb24-5"><a href="regularization.html#cb24-5"></a>    <span class="co"># mixture specifies the type of penalized regression: 0 is ridge regression</span></span>
<span id="cb24-6"><a href="regularization.html#cb24-6"></a>    <span class="kw">linear_reg</span>(<span class="dt">penalty =</span> <span class="dv">0</span>, <span class="dt">mixture =</span> <span class="dv">0</span>),</span>
<span id="cb24-7"><a href="regularization.html#cb24-7"></a>    <span class="st">&quot;glmnet&quot;</span></span>
<span id="cb24-8"><a href="regularization.html#cb24-8"></a>  )</span>
<span id="cb24-9"><a href="regularization.html#cb24-9"></a></span>
<span id="cb24-10"><a href="regularization.html#cb24-10"></a>model1 &lt;-</span>
<span id="cb24-11"><a href="regularization.html#cb24-11"></a><span class="st">  </span>tflow <span class="op">%&gt;%</span></span>
<span id="cb24-12"><a href="regularization.html#cb24-12"></a><span class="st">  </span><span class="kw">plug_model</span>(regularized_reg) <span class="op">%&gt;%</span></span>
<span id="cb24-13"><a href="regularization.html#cb24-13"></a><span class="st">  </span><span class="kw">fit</span>()</span>
<span id="cb24-14"><a href="regularization.html#cb24-14"></a></span>
<span id="cb24-15"><a href="regularization.html#cb24-15"></a><span class="co"># Get ridge coefficients</span></span>
<span id="cb24-16"><a href="regularization.html#cb24-16"></a>mod &lt;-<span class="st"> </span>model1 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull_tflow_fit</span>() <span class="op">%&gt;%</span><span class="st"> </span>.[[<span class="st">&quot;fit&quot;</span>]]</span>
<span id="cb24-17"><a href="regularization.html#cb24-17"></a>ridge_coef &lt;-<span class="st"> </span><span class="kw">predict</span>(mod, <span class="dt">s =</span> <span class="dv">0</span>, <span class="dt">type =</span> <span class="st">&quot;coefficients&quot;</span>)</span>
<span id="cb24-18"><a href="regularization.html#cb24-18"></a></span>
<span id="cb24-19"><a href="regularization.html#cb24-19"></a><span class="co">############################# Linear model ####################################</span></span>
<span id="cb24-20"><a href="regularization.html#cb24-20"></a><span class="co">###############################################################################</span></span>
<span id="cb24-21"><a href="regularization.html#cb24-21"></a></span>
<span id="cb24-22"><a href="regularization.html#cb24-22"></a>model2 &lt;-</span>
<span id="cb24-23"><a href="regularization.html#cb24-23"></a><span class="st">  </span>tflow <span class="op">%&gt;%</span></span>
<span id="cb24-24"><a href="regularization.html#cb24-24"></a><span class="st">  </span><span class="kw">plug_model</span>(<span class="kw">set_engine</span>(<span class="kw">linear_reg</span>(), <span class="st">&quot;lm&quot;</span>)) <span class="op">%&gt;%</span></span>
<span id="cb24-25"><a href="regularization.html#cb24-25"></a><span class="st">  </span><span class="kw">fit</span>()</span>
<span id="cb24-26"><a href="regularization.html#cb24-26"></a></span>
<span id="cb24-27"><a href="regularization.html#cb24-27"></a>lm_coef &lt;-<span class="st"> </span>model2 <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull_tflow_fit</span>() <span class="op">%&gt;%</span><span class="st"> </span>.[[<span class="st">&quot;fit&quot;</span>]] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">coef</span>()</span>
<span id="cb24-28"><a href="regularization.html#cb24-28"></a></span>
<span id="cb24-29"><a href="regularization.html#cb24-29"></a><span class="co">############################# Comparing model #################################</span></span>
<span id="cb24-30"><a href="regularization.html#cb24-30"></a><span class="co">###############################################################################</span></span>
<span id="cb24-31"><a href="regularization.html#cb24-31"></a></span>
<span id="cb24-32"><a href="regularization.html#cb24-32"></a>comparison &lt;-</span>
<span id="cb24-33"><a href="regularization.html#cb24-33"></a><span class="st">  </span><span class="kw">data.frame</span>(<span class="dt">coefs =</span> <span class="kw">names</span>(lm_coef),</span>
<span id="cb24-34"><a href="regularization.html#cb24-34"></a>             <span class="st">`</span><span class="dt">Linear coefficients</span><span class="st">`</span> =<span class="st"> </span><span class="kw">unname</span>(<span class="kw">round</span>(lm_coef, <span class="dv">2</span>)),</span>
<span id="cb24-35"><a href="regularization.html#cb24-35"></a>             <span class="st">`</span><span class="dt">Ridge coefficients</span><span class="st">`</span> =<span class="st"> </span><span class="kw">round</span>(<span class="kw">as.vector</span>(ridge_coef), <span class="dv">2</span>))</span>
<span id="cb24-36"><a href="regularization.html#cb24-36"></a></span>
<span id="cb24-37"><a href="regularization.html#cb24-37"></a>knitr<span class="op">::</span><span class="kw">kable</span>(comparison)</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">coefs</th>
<th align="right">Linear.coefficients</th>
<th align="right">Ridge.coefficients</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">(Intercept)</td>
<td align="right">329.37</td>
<td align="right">331.55</td>
</tr>
<tr class="even">
<td align="left">MISCED</td>
<td align="right">3.88</td>
<td align="right">4.17</td>
</tr>
<tr class="odd">
<td align="left">FISCED</td>
<td align="right">11.93</td>
<td align="right">11.61</td>
</tr>
<tr class="even">
<td align="left">HISEI</td>
<td align="right">17.85</td>
<td align="right">17.36</td>
</tr>
<tr class="odd">
<td align="left">REPEAT</td>
<td align="right">-22.03</td>
<td align="right">-21.41</td>
</tr>
<tr class="even">
<td align="left">IMMIG</td>
<td align="right">6.66</td>
<td align="right">6.41</td>
</tr>
<tr class="odd">
<td align="left">DURECEC</td>
<td align="right">-0.33</td>
<td align="right">-0.27</td>
</tr>
<tr class="even">
<td align="left">BSMJ</td>
<td align="right">9.10</td>
<td align="right">8.96</td>
</tr>
</tbody>
</table>
<p>Coming from a social science background, it might seem counterintuitive that the researcher has to specify tuning parameters for the model. In traditional social science statistics, models usually estimate similar values internally and the user doesn’t have to think about them. However, there are strategies already implemented to explore the combination of many possible values. With our previous example, we have to add <code>tune()</code> to the <code>penalty</code> argument and add a grid for the model to search for the best one:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="regularization.html#cb25-1"></a><span class="co"># Here we add the cross-validation and grid</span></span>
<span id="cb25-2"><a href="regularization.html#cb25-2"></a>tflow &lt;-</span>
<span id="cb25-3"><a href="regularization.html#cb25-3"></a><span class="st">  </span>tflow <span class="op">%&gt;%</span></span>
<span id="cb25-4"><a href="regularization.html#cb25-4"></a><span class="st">  </span><span class="co"># Cross-validation</span></span>
<span id="cb25-5"><a href="regularization.html#cb25-5"></a><span class="st">  </span><span class="kw">plug_resample</span>(vfold_cv, <span class="dt">v =</span> <span class="dv">5</span>) <span class="op">%&gt;%</span></span>
<span id="cb25-6"><a href="regularization.html#cb25-6"></a><span class="st">  </span><span class="co"># Grid</span></span>
<span id="cb25-7"><a href="regularization.html#cb25-7"></a><span class="st">  </span><span class="kw">plug_grid</span>(grid_regular)</span>
<span id="cb25-8"><a href="regularization.html#cb25-8"></a></span>
<span id="cb25-9"><a href="regularization.html#cb25-9"></a>regularized_reg &lt;-<span class="st"> </span><span class="kw">update</span>(regularized_reg, <span class="dt">penalty =</span> <span class="kw">tune</span>())</span>
<span id="cb25-10"><a href="regularization.html#cb25-10"></a></span>
<span id="cb25-11"><a href="regularization.html#cb25-11"></a>res &lt;-</span>
<span id="cb25-12"><a href="regularization.html#cb25-12"></a><span class="st">  </span>tflow <span class="op">%&gt;%</span></span>
<span id="cb25-13"><a href="regularization.html#cb25-13"></a><span class="st">  </span><span class="co"># Update the model to specify that `penalty` will be tuned</span></span>
<span id="cb25-14"><a href="regularization.html#cb25-14"></a><span class="st">  </span><span class="kw">plug_model</span>(regularized_reg) <span class="op">%&gt;%</span></span>
<span id="cb25-15"><a href="regularization.html#cb25-15"></a><span class="st">  </span><span class="kw">fit</span>()</span>
<span id="cb25-16"><a href="regularization.html#cb25-16"></a></span>
<span id="cb25-17"><a href="regularization.html#cb25-17"></a>final_ridge &lt;-<span class="st"> </span><span class="kw">complete_tflow</span>(res, <span class="dt">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span>
<span id="cb25-18"><a href="regularization.html#cb25-18"></a></span>
<span id="cb25-19"><a href="regularization.html#cb25-19"></a>final_ridge <span class="op">%&gt;%</span></span>
<span id="cb25-20"><a href="regularization.html#cb25-20"></a><span class="st">  </span><span class="kw">pull_tflow_fit</span>() <span class="op">%&gt;%</span></span>
<span id="cb25-21"><a href="regularization.html#cb25-21"></a><span class="st">  </span>.[[<span class="st">&quot;fit&quot;</span>]] <span class="op">%&gt;%</span></span>
<span id="cb25-22"><a href="regularization.html#cb25-22"></a><span class="st">  </span><span class="kw">plot</span>(<span class="dt">xvar =</span> <span class="st">&quot;lambda&quot;</span>, <span class="dt">label =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="figs/unnamed-chunk-5-1.png" width="80%" style="display: block; margin: auto;" /></p>
<p>Here we can see how our coefficients are affected by increasing the weight of the <code>penalty</code> parameter. Each of those lines are the coefficients for the variables. The <code>x</code> axis contains the penalty values and we can see how as the penalty increases, the size of the coefficients is shrinking to be close to zero. By around the log of <code>penalty</code> around 8 nearly all coefficients are shrinked very close to zero. This plot is just an exercise to understand how the ridge regression works. In other words, we can figure out the best lambda automatically:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="regularization.html#cb26-1"></a>best_tune &lt;-</span>
<span id="cb26-2"><a href="regularization.html#cb26-2"></a><span class="st">  </span>res <span class="op">%&gt;%</span></span>
<span id="cb26-3"><a href="regularization.html#cb26-3"></a><span class="st">  </span><span class="kw">pull_tflow_fit_tuning</span>() <span class="op">%&gt;%</span></span>
<span id="cb26-4"><a href="regularization.html#cb26-4"></a><span class="st">  </span><span class="kw">select_best</span>(<span class="dt">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span>
<span id="cb26-5"><a href="regularization.html#cb26-5"></a></span>
<span id="cb26-6"><a href="regularization.html#cb26-6"></a>best_tune</span></code></pre></div>
<pre><code>## # A tibble: 1 x 1
##        penalty
##          &lt;dbl&gt;
## 1 0.0000000001</code></pre>
<p>However, there’s no need to calculate this, as <code>complete_tflow</code> figures it out for you (as you can see in the code chunk above, <code>complete_tflow</code> extracts this automatically and fits the best model). We can calculate the <span class="math inline">\(RMSE\)</span> of the training data from the best model and compare it to the predictions on the testing data:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="regularization.html#cb28-1"></a>train_rmse_ridge &lt;-</span>
<span id="cb28-2"><a href="regularization.html#cb28-2"></a><span class="st">  </span>final_ridge <span class="op">%&gt;%</span></span>
<span id="cb28-3"><a href="regularization.html#cb28-3"></a><span class="st">  </span><span class="kw">predict_training</span>() <span class="op">%&gt;%</span></span>
<span id="cb28-4"><a href="regularization.html#cb28-4"></a><span class="st">  </span><span class="kw">rmse</span>(math_score, .pred)</span>
<span id="cb28-5"><a href="regularization.html#cb28-5"></a></span>
<span id="cb28-6"><a href="regularization.html#cb28-6"></a>holdout_ridge &lt;-</span>
<span id="cb28-7"><a href="regularization.html#cb28-7"></a><span class="st">  </span>final_ridge <span class="op">%&gt;%</span></span>
<span id="cb28-8"><a href="regularization.html#cb28-8"></a><span class="st">  </span><span class="kw">predict_testing</span>() <span class="op">%&gt;%</span></span>
<span id="cb28-9"><a href="regularization.html#cb28-9"></a><span class="st">  </span><span class="kw">rmse</span>(math_score, .pred)</span>
<span id="cb28-10"><a href="regularization.html#cb28-10"></a></span>
<span id="cb28-11"><a href="regularization.html#cb28-11"></a>train_rmse_ridge<span class="op">$</span>type &lt;-<span class="st"> &quot;training&quot;</span></span>
<span id="cb28-12"><a href="regularization.html#cb28-12"></a>holdout_ridge<span class="op">$</span>type &lt;-<span class="st"> &quot;testing&quot;</span></span>
<span id="cb28-13"><a href="regularization.html#cb28-13"></a></span>
<span id="cb28-14"><a href="regularization.html#cb28-14"></a>ridge &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">rbind</span>(train_rmse_ridge, holdout_ridge))</span>
<span id="cb28-15"><a href="regularization.html#cb28-15"></a>ridge<span class="op">$</span>model &lt;-<span class="st"> &quot;ridge&quot;</span></span>
<span id="cb28-16"><a href="regularization.html#cb28-16"></a>ridge</span></code></pre></div>
<pre><code>##   .metric .estimator .estimate     type model
## 1    rmse   standard  76.64458 training ridge
## 2    rmse   standard  78.21517  testing ridge</code></pre>
<p>The testing error (RMSE) is higher than the training error, as expected, as the training set nearly always <strong>memorizes</strong> the data better for the training.</p>
</div>
<div id="lasso-regularization" class="section level2">
<h2><span class="header-section-number">2.2</span> Lasso regularization</h2>
<p>The Lasso regularization is very similar to the ridge regularization where only one thing changes: the penalty term. Instead of squaring the coefficients in the penalty term, the lasso regularization takes the absolute value of the coefficient.</p>
<p><span class="math display">\[\begin{equation}
RSS + \lambda \sum_{k = 1}^n |\beta_j|
\end{equation}\]</span></p>
<p>Although it might not be self-evident from this, the lasso reguralization has an important distinction: it can force a coefficient to be exactly zero. This means that lasso does a selection of variables which have big coefficients while not compromising the RSS of the model. The problem with ridge regression is that as the number of variables increases, the training error will almost always improve but the test error will not.</p>
<p>For example, if we define the same model from above using a lasso, you’ll see that it forces coefficients to be <strong>exactly zero</strong> if they don’t add anything relative to the RSS of the model. This means that variables which do not add anything to the model will be excluded unless they add explanatory power that compensates the size of their coefficient. Here’s the same lasso example:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="regularization.html#cb30-1"></a>regularized_reg &lt;-<span class="st"> </span><span class="kw">update</span>(regularized_reg, <span class="dt">mixture =</span> <span class="dv">1</span>)</span>
<span id="cb30-2"><a href="regularization.html#cb30-2"></a></span>
<span id="cb30-3"><a href="regularization.html#cb30-3"></a>res &lt;-</span>
<span id="cb30-4"><a href="regularization.html#cb30-4"></a><span class="st">  </span>tflow <span class="op">%&gt;%</span></span>
<span id="cb30-5"><a href="regularization.html#cb30-5"></a><span class="st">  </span><span class="kw">plug_model</span>(regularized_reg) <span class="op">%&gt;%</span></span>
<span id="cb30-6"><a href="regularization.html#cb30-6"></a><span class="st">  </span><span class="kw">fit</span>()</span>
<span id="cb30-7"><a href="regularization.html#cb30-7"></a></span>
<span id="cb30-8"><a href="regularization.html#cb30-8"></a>final_lasso &lt;-<span class="st"> </span><span class="kw">complete_tflow</span>(res, <span class="dt">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span>
<span id="cb30-9"><a href="regularization.html#cb30-9"></a></span>
<span id="cb30-10"><a href="regularization.html#cb30-10"></a>final_lasso <span class="op">%&gt;%</span></span>
<span id="cb30-11"><a href="regularization.html#cb30-11"></a><span class="st">  </span><span class="kw">pull_tflow_fit</span>() <span class="op">%&gt;%</span></span>
<span id="cb30-12"><a href="regularization.html#cb30-12"></a><span class="st">  </span>.[[<span class="st">&quot;fit&quot;</span>]] <span class="op">%&gt;%</span></span>
<span id="cb30-13"><a href="regularization.html#cb30-13"></a><span class="st">  </span><span class="kw">plot</span>(<span class="dt">xvar =</span> <span class="st">&quot;lambda&quot;</span>, <span class="dt">label =</span> <span class="ot">TRUE</span>)</span></code></pre></div>
<p><img src="figs/unnamed-chunk-8-1.png" width="80%" style="display: block; margin: auto;" /></p>
<p>In contrast to the ridge regression, where coefficients are forced to be close to zero, the lasso penalty actually forces some coefficients <strong>to be zero</strong>. This property means that the lasso makes a <strong>selection of the variables with the higher coefficients</strong> and eliminates those which do not have a strong relationship. Lasso is usually better at model interpretation because it removes redundant variables while ridge can be useful if you want to keep a number of variables in the model, despite them being weak predictors (as controls, for example).</p>
<p>To check the final model and it’s error, we can recycle the code from above and adapt it to the lasso:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="regularization.html#cb31-1"></a>train_rmse_lasso &lt;-</span>
<span id="cb31-2"><a href="regularization.html#cb31-2"></a><span class="st">  </span>final_lasso <span class="op">%&gt;%</span></span>
<span id="cb31-3"><a href="regularization.html#cb31-3"></a><span class="st">  </span><span class="kw">predict_training</span>() <span class="op">%&gt;%</span></span>
<span id="cb31-4"><a href="regularization.html#cb31-4"></a><span class="st">  </span><span class="kw">rmse</span>(math_score, .pred)</span>
<span id="cb31-5"><a href="regularization.html#cb31-5"></a></span>
<span id="cb31-6"><a href="regularization.html#cb31-6"></a>holdout_lasso &lt;-</span>
<span id="cb31-7"><a href="regularization.html#cb31-7"></a><span class="st">  </span>final_lasso <span class="op">%&gt;%</span></span>
<span id="cb31-8"><a href="regularization.html#cb31-8"></a><span class="st">  </span><span class="kw">predict_testing</span>() <span class="op">%&gt;%</span></span>
<span id="cb31-9"><a href="regularization.html#cb31-9"></a><span class="st">  </span><span class="kw">rmse</span>(math_score, .pred)</span>
<span id="cb31-10"><a href="regularization.html#cb31-10"></a></span>
<span id="cb31-11"><a href="regularization.html#cb31-11"></a>train_rmse_lasso<span class="op">$</span>type &lt;-<span class="st"> &quot;training&quot;</span></span>
<span id="cb31-12"><a href="regularization.html#cb31-12"></a>holdout_lasso<span class="op">$</span>type &lt;-<span class="st"> &quot;testing&quot;</span></span>
<span id="cb31-13"><a href="regularization.html#cb31-13"></a></span>
<span id="cb31-14"><a href="regularization.html#cb31-14"></a>lasso &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">rbind</span>(train_rmse_lasso, holdout_lasso))</span>
<span id="cb31-15"><a href="regularization.html#cb31-15"></a>lasso<span class="op">$</span>model &lt;-<span class="st"> &quot;lasso&quot;</span></span>
<span id="cb31-16"><a href="regularization.html#cb31-16"></a>lasso</span></code></pre></div>
<pre><code>##   .metric .estimator .estimate     type model
## 1    rmse   standard  76.63928 training lasso
## 2    rmse   standard  78.23457  testing lasso</code></pre>
<p>So far, we can check which model is performing better:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="regularization.html#cb33-1"></a>model_comparison &lt;-<span class="st"> </span><span class="kw">rbind</span>(ridge, lasso)</span>
<span id="cb33-2"><a href="regularization.html#cb33-2"></a>model_comparison</span></code></pre></div>
<pre><code>##   .metric .estimator .estimate     type model
## 1    rmse   standard  76.64458 training ridge
## 2    rmse   standard  78.21517  testing ridge
## 3    rmse   standard  76.63928 training lasso
## 4    rmse   standard  78.23457  testing lasso</code></pre>
<p>Currently the ridge regression has a very minor advantaged over the lasso yet the difference is probably within the margin of error. Depending on your aim, you might want to choose either of the models. For example, if our models contained a lot of variables, lasso might be more interpretable as it reduces the number of variables. However, if you have reasons to believe that keeping all variables in the model is important, then ridge provides an advantage.</p>
</div>
<div id="elastic-net-regularization" class="section level2">
<h2><span class="header-section-number">2.3</span> Elastic Net regularization</h2>
<p>If you’re aware of ridge and lasso, then elastic net regularization is a logical step. Elastic Net (the name sounds fancy, but it is also an adaptation of OLS) combines both penalties to form one single equation.</p>
<p>Here we define our ridge penalty:</p>
<p><span class="math display">\[ridge = \lambda \sum_{k = 1}^n \beta_j^2\]</span></p>
<p>And here we define our lasso penalty:</p>
<p><span class="math display">\[lasso = \lambda \sum_{k = 1}^n |\beta_j|\]</span></p>
<p>Elastic net regularization is the addition of these two penalties in comparison to the RSS:</p>
<p><span class="math display">\[RSS + lasso + ridge\]</span></p>
<p>I think the best explanation for elastic net regularization comes from <span class="citation">Boehmke and Greenwell (<a href="#ref-boehmke2019" role="doc-biblioref">2019</a>)</span>:</p>
<blockquote>
<p>Although lasso models perform feature selection, when two strongly correlated features are pushed towards zero, one may be pushed fully to zero while the other remains in the model. Furthermore, the process of one being in and one being out is not very systematic. In contrast, the ridge regression penalty is a little more effective in systematically handling correlated features together. Consequently, the advantage of the elastic net penalty is that it enables effective regularization via the ridge penalty with the feature selection characteristics of the lasso penalty.</p>
</blockquote>
<p>Essentially, you now have two tuning parameters. In the grid of values, instead of specifying a <code>mixture</code> of <code>0</code> (ridge) or <code>1</code> (lasso), <code>tidyflow</code> will slide through several values of <code>mixture</code> ranging from 0 to 1 and compare that to several values of <code>lambda</code>. This is formally called a <strong>grid search</strong>.</p>
<p>We can recycle the same code from above:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="regularization.html#cb35-1"></a>regularized_reg &lt;-<span class="st"> </span><span class="kw">update</span>(regularized_reg, <span class="dt">mixture =</span> <span class="kw">tune</span>())</span>
<span id="cb35-2"><a href="regularization.html#cb35-2"></a></span>
<span id="cb35-3"><a href="regularization.html#cb35-3"></a>res &lt;-</span>
<span id="cb35-4"><a href="regularization.html#cb35-4"></a><span class="st">  </span>tflow <span class="op">%&gt;%</span></span>
<span id="cb35-5"><a href="regularization.html#cb35-5"></a><span class="st">  </span><span class="kw">plug_model</span>(regularized_reg) <span class="op">%&gt;%</span></span>
<span id="cb35-6"><a href="regularization.html#cb35-6"></a><span class="st">  </span><span class="kw">fit</span>()</span>
<span id="cb35-7"><a href="regularization.html#cb35-7"></a></span>
<span id="cb35-8"><a href="regularization.html#cb35-8"></a>final_elnet &lt;-<span class="st"> </span><span class="kw">complete_tflow</span>(res, <span class="dt">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span>
<span id="cb35-9"><a href="regularization.html#cb35-9"></a></span>
<span id="cb35-10"><a href="regularization.html#cb35-10"></a>train_rmse_elnet &lt;-</span>
<span id="cb35-11"><a href="regularization.html#cb35-11"></a><span class="st">  </span>final_elnet <span class="op">%&gt;%</span></span>
<span id="cb35-12"><a href="regularization.html#cb35-12"></a><span class="st">  </span><span class="kw">predict_training</span>() <span class="op">%&gt;%</span></span>
<span id="cb35-13"><a href="regularization.html#cb35-13"></a><span class="st">  </span><span class="kw">rmse</span>(math_score, .pred)</span>
<span id="cb35-14"><a href="regularization.html#cb35-14"></a></span>
<span id="cb35-15"><a href="regularization.html#cb35-15"></a>holdout_elnet &lt;-</span>
<span id="cb35-16"><a href="regularization.html#cb35-16"></a><span class="st">  </span>final_elnet <span class="op">%&gt;%</span></span>
<span id="cb35-17"><a href="regularization.html#cb35-17"></a><span class="st">  </span><span class="kw">predict_testing</span>() <span class="op">%&gt;%</span></span>
<span id="cb35-18"><a href="regularization.html#cb35-18"></a><span class="st">  </span><span class="kw">rmse</span>(math_score, .pred)</span>
<span id="cb35-19"><a href="regularization.html#cb35-19"></a></span>
<span id="cb35-20"><a href="regularization.html#cb35-20"></a>train_rmse_elnet<span class="op">$</span>type &lt;-<span class="st"> &quot;training&quot;</span></span>
<span id="cb35-21"><a href="regularization.html#cb35-21"></a>holdout_elnet<span class="op">$</span>type &lt;-<span class="st"> &quot;testing&quot;</span></span>
<span id="cb35-22"><a href="regularization.html#cb35-22"></a></span>
<span id="cb35-23"><a href="regularization.html#cb35-23"></a>elnet &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">rbind</span>(train_rmse_elnet, holdout_elnet))</span>
<span id="cb35-24"><a href="regularization.html#cb35-24"></a>elnet<span class="op">$</span>model &lt;-<span class="st"> &quot;elnet&quot;</span></span>
<span id="cb35-25"><a href="regularization.html#cb35-25"></a>elnet</span></code></pre></div>
<pre><code>##   .metric .estimator .estimate     type model
## 1    rmse   standard  76.63928 training elnet
## 2    rmse   standard  78.23457  testing elnet</code></pre>
<p>The RMSE of the elastic net is somewhat lower than then ridge and lasso but also probably within the margin of error. Let’s compare it visually:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="regularization.html#cb37-1"></a>model_comparison &lt;-<span class="st"> </span><span class="kw">rbind</span>(model_comparison, elnet)</span>
<span id="cb37-2"><a href="regularization.html#cb37-2"></a></span>
<span id="cb37-3"><a href="regularization.html#cb37-3"></a>model_comparison <span class="op">%&gt;%</span></span>
<span id="cb37-4"><a href="regularization.html#cb37-4"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(model, .estimate, <span class="dt">color =</span> type, <span class="dt">group =</span> type)) <span class="op">+</span></span>
<span id="cb37-5"><a href="regularization.html#cb37-5"></a><span class="st">  </span><span class="kw">geom_point</span>(<span class="dt">position =</span> <span class="st">&quot;dodge&quot;</span>) <span class="op">+</span></span>
<span id="cb37-6"><a href="regularization.html#cb37-6"></a><span class="st">  </span><span class="kw">geom_line</span>() <span class="op">+</span></span>
<span id="cb37-7"><a href="regularization.html#cb37-7"></a><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">name =</span> <span class="st">&quot;RMSE&quot;</span>) <span class="op">+</span></span>
<span id="cb37-8"><a href="regularization.html#cb37-8"></a><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">name =</span> <span class="st">&quot;Models&quot;</span>) <span class="op">+</span></span>
<span id="cb37-9"><a href="regularization.html#cb37-9"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span></code></pre></div>
<p><img src="figs/unnamed-chunk-12-1.png" width="80%" style="display: block; margin: auto;" /></p>
</div>
<div id="exercises" class="section level2">
<h2><span class="header-section-number">2.4</span> Exercises</h2>
<p>The <a href="https://www.fragilefamilieschallenge.org/">Fragile Families Challenge</a> is a study that aimed to predict a series of indicators of children at age 15 only using data from ages 0 to 9. With this challenge, the principal investigators wanted to test whether skills such as cognitive and non-cognitive abilities were correctly predicted. With that idea in mind, they were interested in following up children that beat the ‘predictions’: those children that exceeded the model’s prediction, for example given their initial conditions.</p>
<p>Using a similarly constructed non-cognitive proxy, I’ve created a non-cognitive index using the PISA 2018 for the United States which is the average of the questions:</p>
<ul>
<li>ST182Q03HA - I find satisfaction in working as hard as I can.</li>
<li>ST182Q04HA - Once I start a task, I persist until it is finished.</li>
<li>ST182Q05HA - Part of the enjoyment I get from doing things is when I improve on my past performance.</li>
<li>ST182Q06HA - If I am not good at something, I would rather keep struggling to master it than move on to something I may […]</li>
</ul>
<p>The scale of the index goes from 1 to 4, where in 4 the student strongly agrees and 1 is they completely disagree. In other words, this index shows that the higher the value, the higher the non cognitive skills. You can check out the complete PISA codebook <a href="https://docs.google.com/spreadsheets/d/12--3vD737rcu6olviKutRLEiyKNZ2bynXcJ4CpwtNsQ/edit?usp=sharing">here</a>.</p>
<p>In these series of exercises you will have to try different models that predict this index of non-cognitive skills, perform a grid search for the three models and compare the predictions of the three models.</p>
<p>First, read in the data with:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="regularization.html#cb38-1"></a><span class="kw">library</span>(tidymodels)</span>
<span id="cb38-2"><a href="regularization.html#cb38-2"></a><span class="kw">library</span>(tidyflow)</span>
<span id="cb38-3"><a href="regularization.html#cb38-3"></a></span>
<span id="cb38-4"><a href="regularization.html#cb38-4"></a>data_link &lt;-<span class="st"> &quot;https://raw.githubusercontent.com/cimentadaj/ml_socsci/master/data/pisa_us_2018.csv&quot;</span></span>
<span id="cb38-5"><a href="regularization.html#cb38-5"></a>pisa &lt;-<span class="st"> </span><span class="kw">read.csv</span>(data_link)</span></code></pre></div>
<div id="ex1" class="section level4 unnumbered">
<h4>1. Create a <code>tidyflow</code> with a split</h4>
<ul>
<li>Begin with the data <code>pisa</code></li>
<li>To plug a split, use <code>initial_split</code></li>
</ul>
<p>Remember to set the seed to <code>2341</code> so that everyone can compare their results.</p>
<details>
<p><summary><strong>&gt; Answer </strong></summary></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="regularization.html#cb39-1"></a>tflow &lt;-</span>
<span id="cb39-2"><a href="regularization.html#cb39-2"></a><span class="st">  </span>pisa <span class="op">%&gt;%</span></span>
<span id="cb39-3"><a href="regularization.html#cb39-3"></a><span class="st">  </span><span class="kw">tidyflow</span>(<span class="dt">seed =</span> <span class="dv">2341</span>) <span class="op">%&gt;%</span></span>
<span id="cb39-4"><a href="regularization.html#cb39-4"></a><span class="st">  </span><span class="kw">plug_split</span>(initial_split)</span>
<span id="cb39-5"><a href="regularization.html#cb39-5"></a></span>
<span id="cb39-6"><a href="regularization.html#cb39-6"></a>tflow</span></code></pre></div>
</details>
</div>
<div id="ex2" class="section level4 unnumbered">
<h4>2. Run a ridge regression with non-cognitive as the dependent variable</h4>
<ul>
<li><p>Plug in a formula (hint, look at <code>?plug_formula</code>) and use as many variables as you want (you can reuse the previous variables from the examples or pick all of them). A formula of the like <code>noncogn ~ .</code> will regress <code>noncogn</code> on all variables.</p></li>
<li><p>Plug in the ridge regression with <code>penalty</code> set to <code>0.001</code> (hint: remember to set <code>mixture</code> to the value corresponding to the ridge regression)</p></li>
<li><p>Fit the ridge model (with <code>fit</code>)</p></li>
<li><p>Predict on the training data with <code>predict_training</code> and explore the <span class="math inline">\(R^2\)</span> (<code>rsq</code>) and <span class="math inline">\(RMSE\)</span> (<code>rmse</code>).</p></li>
</ul>
<details>
<p><summary><strong>&gt; Answer </strong></summary></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="regularization.html#cb40-1"></a>ridge_mod &lt;-<span class="st"> </span><span class="kw">set_engine</span>(<span class="kw">linear_reg</span>(<span class="dt">penalty =</span> <span class="fl">0.001</span>, <span class="dt">mixture =</span> <span class="dv">0</span>), <span class="st">&quot;glmnet&quot;</span>)</span>
<span id="cb40-2"><a href="regularization.html#cb40-2"></a></span>
<span id="cb40-3"><a href="regularization.html#cb40-3"></a>tflow &lt;-</span>
<span id="cb40-4"><a href="regularization.html#cb40-4"></a><span class="st">  </span>tflow <span class="op">%&gt;%</span></span>
<span id="cb40-5"><a href="regularization.html#cb40-5"></a><span class="st">  </span><span class="kw">plug_formula</span>(noncogn <span class="op">~</span><span class="st"> </span>.) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb40-6"><a href="regularization.html#cb40-6"></a><span class="st">  </span><span class="kw">plug_model</span>(ridge_mod)</span>
<span id="cb40-7"><a href="regularization.html#cb40-7"></a></span>
<span id="cb40-8"><a href="regularization.html#cb40-8"></a>m1 &lt;-<span class="st"> </span><span class="kw">fit</span>(tflow)</span>
<span id="cb40-9"><a href="regularization.html#cb40-9"></a></span>
<span id="cb40-10"><a href="regularization.html#cb40-10"></a>m1_rsq &lt;-<span class="st"> </span><span class="kw">predict_training</span>(m1) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rsq</span>(noncogn, .pred)</span>
<span id="cb40-11"><a href="regularization.html#cb40-11"></a>m1_rmse &lt;-<span class="st"> </span><span class="kw">predict_training</span>(m1) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rmse</span>(noncogn, .pred)</span></code></pre></div>
</details>
</div>
<div id="ex3" class="section level4 unnumbered">
<h4>3. Add a recipe to scale all of the predictors and rerun the previous model</h4>
<ul>
<li><p>Drop the formula from the <code>tidyflow</code> with <code>drop_formula</code></p></li>
<li><p>Add a recipe with the same formula you had, but including the <code>step_scale</code> for all predictors</p></li>
<li><p>Rerun the model and extract the <span class="math inline">\(R^2\)</span> and <span class="math inline">\(RMSE\)</span></p></li>
</ul>
<p>How does the <span class="math inline">\(R^2\)</span> and <span class="math inline">\(RMSE\)</span> change? Was there an impact in change?</p>
<details>
<p><summary><strong>&gt; Answer </strong></summary></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="regularization.html#cb41-1"></a>rcp &lt;-</span>
<span id="cb41-2"><a href="regularization.html#cb41-2"></a><span class="st">  </span><span class="er">~</span><span class="st"> </span><span class="kw">recipe</span>(noncogn <span class="op">~</span><span class="st"> </span>., <span class="dt">data =</span> .) <span class="op">%&gt;%</span></span>
<span id="cb41-3"><a href="regularization.html#cb41-3"></a><span class="st">    </span><span class="kw">step_scale</span>(<span class="kw">all_predictors</span>())</span>
<span id="cb41-4"><a href="regularization.html#cb41-4"></a></span>
<span id="cb41-5"><a href="regularization.html#cb41-5"></a>tflow &lt;-</span>
<span id="cb41-6"><a href="regularization.html#cb41-6"></a><span class="st">  </span>tflow <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb41-7"><a href="regularization.html#cb41-7"></a><span class="st">  </span><span class="kw">drop_formula</span>() <span class="op">%&gt;%</span></span>
<span id="cb41-8"><a href="regularization.html#cb41-8"></a><span class="st">  </span><span class="kw">plug_recipe</span>(rcp)</span>
<span id="cb41-9"><a href="regularization.html#cb41-9"></a></span>
<span id="cb41-10"><a href="regularization.html#cb41-10"></a>m2 &lt;-<span class="st"> </span><span class="kw">fit</span>(tflow)</span>
<span id="cb41-11"><a href="regularization.html#cb41-11"></a></span>
<span id="cb41-12"><a href="regularization.html#cb41-12"></a>m2_rsq &lt;-<span class="st"> </span><span class="kw">predict_training</span>(m2) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rsq</span>(noncogn, .pred)</span>
<span id="cb41-13"><a href="regularization.html#cb41-13"></a>m2_rmse &lt;-<span class="st"> </span><span class="kw">predict_training</span>(m2) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">rmse</span>(noncogn, .pred)</span></code></pre></div>
</details>
</div>
<div id="ex4" class="section level4 unnumbered">
<h4>4. Adapt the previous model to do a grid search of <code>penalty</code> values</h4>
<ul>
<li>Add a cross-validation resample (<code>vfold_cv</code>)</li>
<li>Add a tuning grid (<code>grid_regular</code>) and specify <code>levels = 10</code>. This will create a tuning grid of 10 values</li>
<li>Update the <code>penalty</code> parameter to be <code>tune</code>d</li>
<li>Run the grid search (<code>fit</code>)</li>
<li>Extract the tuning grid (<code>pull_tflow_fit_tuning</code>) and visualize <code>autoplot</code></li>
</ul>
<p>Is there a pattern with the improvement/decrease of the metrics of fit with respect to the <code>penalty</code>?</p>
<details>
<p><summary><strong>&gt; Answer </strong></summary></p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="regularization.html#cb42-1"></a>ridge_mod &lt;-<span class="st"> </span><span class="kw">update</span>(ridge_mod, <span class="dt">penalty =</span> <span class="kw">tune</span>())</span>
<span id="cb42-2"><a href="regularization.html#cb42-2"></a></span>
<span id="cb42-3"><a href="regularization.html#cb42-3"></a>tflow &lt;-</span>
<span id="cb42-4"><a href="regularization.html#cb42-4"></a><span class="st">  </span>tflow <span class="op">%&gt;%</span></span>
<span id="cb42-5"><a href="regularization.html#cb42-5"></a><span class="st">  </span><span class="kw">replace_model</span>(ridge_mod) <span class="op">%&gt;%</span></span>
<span id="cb42-6"><a href="regularization.html#cb42-6"></a><span class="st">  </span><span class="kw">plug_resample</span>(vfold_cv) <span class="op">%&gt;%</span></span>
<span id="cb42-7"><a href="regularization.html#cb42-7"></a><span class="st">  </span><span class="kw">plug_grid</span>(grid_regular, <span class="dt">levels =</span> <span class="dv">10</span>)</span>
<span id="cb42-8"><a href="regularization.html#cb42-8"></a></span>
<span id="cb42-9"><a href="regularization.html#cb42-9"></a>m3 &lt;-<span class="st"> </span><span class="kw">fit</span>(tflow)</span>
<span id="cb42-10"><a href="regularization.html#cb42-10"></a></span>
<span id="cb42-11"><a href="regularization.html#cb42-11"></a>m3 <span class="op">%&gt;%</span></span>
<span id="cb42-12"><a href="regularization.html#cb42-12"></a><span class="st">  </span><span class="kw">pull_tflow_fit_tuning</span>() <span class="op">%&gt;%</span></span>
<span id="cb42-13"><a href="regularization.html#cb42-13"></a><span class="st">  </span><span class="kw">autoplot</span>()</span></code></pre></div>
</details>
</div>
<div id="ex5" class="section level4 unnumbered">
<h4>5. Run a lasso regression with the same specification as above</h4>
<ul>
<li>Update the model to have a mixture of <code>1</code> (this is specifying that we want a lasso)</li>
<li>Run the grid search (<code>fit</code>)</li>
<li>Extract the tuning grid (<code>pull_tflow_fit_tuning</code>) and visualize <code>autoplot</code></li>
</ul>
<p>Which model is performing better? Ridge or Lasso? Can you comment on the pattern of the penalty between ridge and lasso?</p>
<details>
<p><summary><strong>&gt; Answer </strong></summary></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="regularization.html#cb43-1"></a>lasso_mod &lt;-<span class="st"> </span><span class="kw">update</span>(ridge_mod, <span class="dt">mixture =</span> <span class="dv">1</span>)</span>
<span id="cb43-2"><a href="regularization.html#cb43-2"></a></span>
<span id="cb43-3"><a href="regularization.html#cb43-3"></a>m4 &lt;-</span>
<span id="cb43-4"><a href="regularization.html#cb43-4"></a><span class="st">  </span>tflow <span class="op">%&gt;%</span></span>
<span id="cb43-5"><a href="regularization.html#cb43-5"></a><span class="st">  </span><span class="kw">replace_model</span>(lasso_mod) <span class="op">%&gt;%</span></span>
<span id="cb43-6"><a href="regularization.html#cb43-6"></a><span class="st">  </span><span class="kw">fit</span>()</span>
<span id="cb43-7"><a href="regularization.html#cb43-7"></a></span>
<span id="cb43-8"><a href="regularization.html#cb43-8"></a>m4 <span class="op">%&gt;%</span></span>
<span id="cb43-9"><a href="regularization.html#cb43-9"></a><span class="st">  </span><span class="kw">pull_tflow_fit_tuning</span>() <span class="op">%&gt;%</span></span>
<span id="cb43-10"><a href="regularization.html#cb43-10"></a><span class="st">  </span><span class="kw">autoplot</span>()</span></code></pre></div>
</details>
</div>
<div id="ex6" class="section level4 unnumbered">
<h4>6. Run an elastic net regression on non cognitive skills</h4>
<ul>
<li>Update the model to have a <code>tune</code>d mixture</li>
<li>Replace the model in the <code>tidyflow</code> with the elastic net model</li>
<li>Run the grid search (<code>fit</code>)</li>
<li>Extract the tuning grid (<code>pull_tflow_fit_tuning</code>) and visualize <code>autoplot</code></li>
</ul>
<details>
<p><summary><strong>&gt; Answer </strong></summary></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="regularization.html#cb44-1"></a>elnet_mod &lt;-<span class="st"> </span><span class="kw">update</span>(lasso_mod, <span class="dt">mixture =</span> <span class="kw">tune</span>())</span>
<span id="cb44-2"><a href="regularization.html#cb44-2"></a></span>
<span id="cb44-3"><a href="regularization.html#cb44-3"></a>m5 &lt;-</span>
<span id="cb44-4"><a href="regularization.html#cb44-4"></a><span class="st">  </span>tflow <span class="op">%&gt;%</span></span>
<span id="cb44-5"><a href="regularization.html#cb44-5"></a><span class="st">  </span><span class="kw">replace_model</span>(elnet_mod) <span class="op">%&gt;%</span></span>
<span id="cb44-6"><a href="regularization.html#cb44-6"></a><span class="st">  </span><span class="kw">fit</span>()</span>
<span id="cb44-7"><a href="regularization.html#cb44-7"></a></span>
<span id="cb44-8"><a href="regularization.html#cb44-8"></a>m5 <span class="op">%&gt;%</span></span>
<span id="cb44-9"><a href="regularization.html#cb44-9"></a><span class="st">  </span><span class="kw">pull_tflow_fit_tuning</span>() <span class="op">%&gt;%</span></span>
<span id="cb44-10"><a href="regularization.html#cb44-10"></a><span class="st">  </span><span class="kw">autoplot</span>()</span>
<span id="cb44-11"><a href="regularization.html#cb44-11"></a></span>
<span id="cb44-12"><a href="regularization.html#cb44-12"></a><span class="co"># Additional plot with standard error</span></span>
<span id="cb44-13"><a href="regularization.html#cb44-13"></a><span class="kw">library</span>(tidyr)</span>
<span id="cb44-14"><a href="regularization.html#cb44-14"></a>m5 <span class="op">%&gt;%</span></span>
<span id="cb44-15"><a href="regularization.html#cb44-15"></a><span class="st">  </span><span class="kw">pull_tflow_fit_tuning</span>() <span class="op">%&gt;%</span></span>
<span id="cb44-16"><a href="regularization.html#cb44-16"></a><span class="st">  </span><span class="kw">collect_metrics</span>() <span class="op">%&gt;%</span></span>
<span id="cb44-17"><a href="regularization.html#cb44-17"></a><span class="st">  </span><span class="kw">pivot_longer</span>(penalty<span class="op">:</span>mixture) <span class="op">%&gt;%</span></span>
<span id="cb44-18"><a href="regularization.html#cb44-18"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">low =</span> mean <span class="op">-</span><span class="st"> </span>(std_err <span class="op">*</span><span class="st"> </span><span class="dv">2</span>),</span>
<span id="cb44-19"><a href="regularization.html#cb44-19"></a>         <span class="dt">high =</span> mean <span class="op">+</span><span class="st"> </span>(std_err <span class="op">*</span><span class="st"> </span><span class="dv">2</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb44-20"><a href="regularization.html#cb44-20"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(value, mean)) <span class="op">+</span></span>
<span id="cb44-21"><a href="regularization.html#cb44-21"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb44-22"><a href="regularization.html#cb44-22"></a><span class="st">  </span><span class="kw">geom_errorbar</span>(<span class="kw">aes</span>(<span class="dt">ymin =</span> low, <span class="dt">ymax =</span> high)) <span class="op">+</span></span>
<span id="cb44-23"><a href="regularization.html#cb44-23"></a><span class="st">  </span><span class="kw">facet_grid</span>(.metric <span class="op">~</span><span class="st"> </span>name)</span></code></pre></div>
</details>
</div>
<div id="ex7" class="section level4 unnumbered">
<h4>7. Compare the three models</h4>
<ul>
<li>Finalize the three models (the ridge model, the lasso model and the elastic net model) with <code>complete_tflow</code>. Remember to set the <code>metric</code>!</li>
<li>Use the three finalized models (the ones that were produced by <code>complete_tflow</code>) to <code>predict_training</code> and <code>predict_testing</code> on each one</li>
<li>Calculate the <code>rmse</code> of the three models on both training and testing</li>
<li>Visualize the three models and their error for training/testing</li>
<li>Comment on which models is better in out-of-sample fit</li>
<li>Is it better to keep the most accurate model or a model that includes relevant confounders (even if they’re relationship is somewhat weak)?</li>
</ul>
<details>
<p><summary><strong>&gt; Answer </strong></summary></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="regularization.html#cb45-1"></a><span class="co"># Since we will be repeating the same process many times</span></span>
<span id="cb45-2"><a href="regularization.html#cb45-2"></a><span class="co"># let&#39;s write a function to predict on the training/testing</span></span>
<span id="cb45-3"><a href="regularization.html#cb45-3"></a><span class="co"># and combine them. This function will accept a single</span></span>
<span id="cb45-4"><a href="regularization.html#cb45-4"></a><span class="co"># model and produce a data frame with the RMSE error for</span></span>
<span id="cb45-5"><a href="regularization.html#cb45-5"></a><span class="co"># training and testing. This way, we can reuse the code</span></span>
<span id="cb45-6"><a href="regularization.html#cb45-6"></a><span class="co"># without having to copy everything many times</span></span>
<span id="cb45-7"><a href="regularization.html#cb45-7"></a>calculate_err &lt;-<span class="st"> </span><span class="cf">function</span>(final_model, <span class="dt">type_model =</span> <span class="ot">NULL</span>) {</span>
<span id="cb45-8"><a href="regularization.html#cb45-8"></a>  final_model &lt;-<span class="st"> </span><span class="kw">complete_tflow</span>(final_model, <span class="dt">metric =</span> <span class="st">&quot;rmse&quot;</span>)</span>
<span id="cb45-9"><a href="regularization.html#cb45-9"></a>  err_train &lt;-</span>
<span id="cb45-10"><a href="regularization.html#cb45-10"></a><span class="st">    </span>final_model <span class="op">%&gt;%</span></span>
<span id="cb45-11"><a href="regularization.html#cb45-11"></a><span class="st">    </span><span class="kw">predict_training</span>() <span class="op">%&gt;%</span></span>
<span id="cb45-12"><a href="regularization.html#cb45-12"></a><span class="st">    </span><span class="kw">rmse</span>(noncogn, .pred)</span>
<span id="cb45-13"><a href="regularization.html#cb45-13"></a>  </span>
<span id="cb45-14"><a href="regularization.html#cb45-14"></a>  err_test &lt;-</span>
<span id="cb45-15"><a href="regularization.html#cb45-15"></a><span class="st">    </span>final_model <span class="op">%&gt;%</span></span>
<span id="cb45-16"><a href="regularization.html#cb45-16"></a><span class="st">    </span><span class="kw">predict_testing</span>() <span class="op">%&gt;%</span></span>
<span id="cb45-17"><a href="regularization.html#cb45-17"></a><span class="st">    </span><span class="kw">rmse</span>(noncogn, .pred)</span>
<span id="cb45-18"><a href="regularization.html#cb45-18"></a></span>
<span id="cb45-19"><a href="regularization.html#cb45-19"></a>  err_train<span class="op">$</span>type &lt;-<span class="st"> &quot;train&quot;</span></span>
<span id="cb45-20"><a href="regularization.html#cb45-20"></a>  err_test<span class="op">$</span>type &lt;-<span class="st"> &quot;test&quot;</span></span>
<span id="cb45-21"><a href="regularization.html#cb45-21"></a>  res &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(<span class="kw">rbind</span>(err_train, err_test))</span>
<span id="cb45-22"><a href="regularization.html#cb45-22"></a>  res<span class="op">$</span>model &lt;-<span class="st"> </span>type_model</span>
<span id="cb45-23"><a href="regularization.html#cb45-23"></a>  res</span>
<span id="cb45-24"><a href="regularization.html#cb45-24"></a>}</span>
<span id="cb45-25"><a href="regularization.html#cb45-25"></a></span>
<span id="cb45-26"><a href="regularization.html#cb45-26"></a>final_res &lt;-</span>
<span id="cb45-27"><a href="regularization.html#cb45-27"></a><span class="st">  </span><span class="kw">rbind</span>(</span>
<span id="cb45-28"><a href="regularization.html#cb45-28"></a>    <span class="kw">calculate_err</span>(m3, <span class="st">&quot;ridge&quot;</span>),</span>
<span id="cb45-29"><a href="regularization.html#cb45-29"></a>    <span class="kw">calculate_err</span>(m4, <span class="st">&quot;lasso&quot;</span>),</span>
<span id="cb45-30"><a href="regularization.html#cb45-30"></a>    <span class="kw">calculate_err</span>(m5, <span class="st">&quot;elnet&quot;</span>)</span>
<span id="cb45-31"><a href="regularization.html#cb45-31"></a>  )</span>
<span id="cb45-32"><a href="regularization.html#cb45-32"></a></span>
<span id="cb45-33"><a href="regularization.html#cb45-33"></a>final_res <span class="op">%&gt;%</span></span>
<span id="cb45-34"><a href="regularization.html#cb45-34"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(model, .estimate, <span class="dt">color =</span> type)) <span class="op">+</span></span>
<span id="cb45-35"><a href="regularization.html#cb45-35"></a><span class="st">  </span><span class="kw">geom_point</span>() <span class="op">+</span></span>
<span id="cb45-36"><a href="regularization.html#cb45-36"></a><span class="st">  </span><span class="kw">theme_minimal</span>()</span>
<span id="cb45-37"><a href="regularization.html#cb45-37"></a></span>
<span id="cb45-38"><a href="regularization.html#cb45-38"></a><span class="co">## BONUS</span></span>
<span id="cb45-39"><a href="regularization.html#cb45-39"></a><span class="co">## Fit a linear regression and compare the four models</span></span>
<span id="cb45-40"><a href="regularization.html#cb45-40"></a><span class="co">## What is the best model to pick considering both accuracy and simplicity?</span></span></code></pre></div>
</details>

</div>
</div>
</div>
<h3>References</h3>
<div id="refs" class="references">
<div id="ref-boehmke2019">
<p>Boehmke, Brad, and Brandon M Greenwell. 2019. <em>Hands-on Machine Learning with R</em>. CRC Press.</p>
</div>
<div id="ref-james2013">
<p>James, Gareth, Daniela Witten, Trevor Hastie, and Robert Tibshirani. 2013. <em>An Introduction to Statistical Learning</em>. Vol. 112. Springer.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="machine-learning-for-social-scientists.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="tree-based-methods.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
